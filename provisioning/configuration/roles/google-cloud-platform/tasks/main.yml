---
- name: Create directory to store keys
  file:
    name: /root/keys
    state: directory

- name: Download key for external package repository
  get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /root/keys/google-cloud

- name: Install keys for external package repositories
  command: apt-key add /root/keys/google-cloud

- name: Add apt sources
  lineinfile:
    dest: '/etc/apt/sources.list.d/google-cloud.list'
    line: deb http://packages.cloud.google.com/apt cloud-sdk-xenial main
    create: true
  register: add_google_cloud_source

- name: Update package repository
  command: apt-get update
  when: add_google_cloud_source.changed

- name: Install system package
  apt:
    name:  google-cloud-sdk
    state: present

- name: ensure we have the latest google-sdk
  command: pip install --upgrade google-cloud
  async: 0
  poll: 0
  ignore_errors: true

# This file was generated by creating a Google Cloud "service account" via
# the Google Cloud Platform console as per the instructions here:
#
# https://cloud.google.com/docs/authentication/getting-started
- name: Copy Google Cloud Platform service account credentials into place
  copy:
    src: files/google-cloud-platform-credentials.json.encrypted
    dest: /home/{{application_user}}/google-cloud-platform-credentials.json
    owner: '{{application_user}}'
    group: '{{application_group}}'
    mode: 0400

- name: Define Google Cloud Platform service account credentials
  lineinfile:
    path: /home/{{application_user}}/.bash_profile
    line: export GOOGLE_APPLICATION_CREDENTIALS=/home/{{application_user}}/google-cloud-platform-credentials.json
    create: true
    owner: '{{application_user}}'
    group: '{{application_group}}'

- name: Activate Google Cloud Platform service account
  command: |
    sudo --login --user {{application_user}} \
      gcloud auth activate-service-account \
        --key-file /home/{{application_user}}/google-cloud-platform-credentials.json
